<div class="teacher-student-detail">
  <h2><%= @student.name %> ã•ã‚“ã®é€²æ—ç®¡ç†</h2>
  <p class="student-detail-goal">ç›®æ¨™æ ¡ï¼š<%= @student.goal_school %></p>

  <!-- ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ é€²æ— -->
  <section class="curriculum-section">
    <h3>ğŸ“˜ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ é€²æ—</h3>
    <table class="curriculum-table">
      <thead>
        <tr>
          <th>æ•™æå</th>
          <th>å˜å…ƒå</th>
          <th>é€²æ—ç‡</th>
          <th>æœŸé–“</th>
        </tr>
      </thead>
      <tbody>
        <% @textbooks.each do |textbook| %>
          <% textbook.units.each do |unit| %>
            <% progress = unit.progresses.find_by(student_id: @student.id) %>
            <% completed = progress ? (progress.completed || 0) : 0 %>
            <tr>
              <td><%= textbook.title %></td>
              <td><%= unit.title %></td>
              <td>
                <div class="progress-bar-container">
                  <div class="progress-bar" style="width: <%= completed %>%;"></div>
                  <span class="progress-text"><%= completed %>%</span>
                </div>
              </td>
              <td>
                <% if progress&.start_date && progress&.end_date %>
                  <%= progress.start_date.strftime("%m/%d") %>ã€œ<%= progress.end_date.strftime("%m/%d") %>
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </section>

  <hr>

  <!-- å­¦ç¿’æ™‚é–“ã®å¯è¦–åŒ– -->
  <section class="study-time-section">
    <h3>â° å­¦ç¿’æ™‚é–“ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <canvas id="teacherStudyChart"></canvas>
  </section>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("turbo:load", () => {
    const ctx = document.getElementById("teacherStudyChart");
    if (!ctx) return;

    const labels = <%= @student.study_times.where(study_date: 7.days.ago.to_date..Date.today)
                             .order(:study_date)
                             .pluck(:study_date)
                             .map { |d| d.strftime('%m/%d') }
                             .to_json.html_safe %>;

    const data = <%= @student.study_times.where(study_date: 7.days.ago.to_date..Date.today)
                             .order(:study_date)
                             .pluck(:minutes)
                             .to_json.html_safe %>;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰',
          data: data,
          backgroundColor: '#6366f1'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'åˆ†' }
          }
        }
      }
    });
  });
</script>