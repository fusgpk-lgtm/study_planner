<div class="student-detail">
  <h2 class="student-detail-name"><%= @student.name %> ã•ã‚“ã®å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
  <p class="student-detail-goal">ç›®æ¨™æ ¡ï¼š<%= @student.goal_school %></p>

  <div class="progress-summary">
    <p>å…¨ä½“é€²æ—ï¼š<%= @student.progress_percentage %>%</p>
    <div class="progress-bar-container">
      <div class="progress-bar" style="width: <%= @student.progress_percentage %>%;"></div>
    </div>
  </div>

  <% @textbooks.each do |textbook| %>
    <div class="textbook-section">
      <h3 class="textbook-title"><%= textbook.title %></h3>

      <!-- ã‚¹ãƒãƒ›å¯¾å¿œï¼štableã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã« -->
      <div class="table-wrapper">
        <table class="unit-table">
          <thead>
            <tr>
              <th>å˜å…ƒ</th>
              <th>é€²æ—</th>
              <th>æœŸé–“</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <% textbook.units.each do |unit| %>
              <tr>
                <td class="unit-title"><%= unit.title %></td>
                <td class="unit-progress">
                  <div class="unit-progress-bar">
                    <div class="fill" style="width: <%= unit.progress %>%;"></div>
                  </div>
                  <span class="progress-text"><%= unit.progress %>%</span>
                </td>
                <td class="unit-dates">
                  <%= unit.start_date %> ~ <%= unit.end_date %>
                </td>
                <td class="unit-actions">
                  <% if unit.progress < 100 %>
                    <button class="btn-complete">å®Œäº†</button>
                  <% else %>
                    <span class="status-done">å®Œäº†æ¸ˆã¿</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <hr>

  <div class="study-time-section">
  <h3>ğŸ“Š å­¦ç¿’æ™‚é–“ã®è¨˜éŒ²</h3>

  <%= form_with model: [@student, StudyTime.new], local: true do |f| %>
    <div class="form-group">
      <%= f.label :study_date, "æ—¥ä»˜" %>
      <%= f.date_field :study_date, value: Date.today %>
    </div>

    <div class="form-group">
      <%= f.label :minutes, "å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰" %>
      <%= f.number_field :minutes, min: 1, step: 5 %>
    </div>

    <%= f.submit "è¨˜éŒ²ã™ã‚‹", class: "btn-save" %>
  <% end %>
</div>

<hr>

<div class="study-time-chart">
  <h3>ğŸ—“ 1é€±é–“ã®å­¦ç¿’æ™‚é–“</h3>
  <canvas id="studyChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("turbo:load", () => {
    const ctx = document.getElementById("studyChart");
    if (!ctx) return;

    const labels = <%= @student.study_times.where(study_date: 7.days.ago.to_date..Date.today)
                              .order(:study_date)
                              .pluck(:study_date).map(&:strftime).to_json.html_safe %>;
    const data = <%= @student.study_times.where(study_date: 7.days.ago.to_date..Date.today)
                              .order(:study_date)
                              .pluck(:minutes).to_json.html_safe %>;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰',
          data: data,
          backgroundColor: '#6366f1'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'åˆ†' } }
        }
      }
    });
  });
</script>