<div class="student-detail">
  <h2 class="student-detail-name"><%= @student.name %> さんの学習スケジュール</h2>
  <p class="student-detail-goal">目標校：<%= @student.goal_school %></p>

  <div class="progress-summary">
    <p>全体進捗：<%= @student.progress_percentage %>%</p>
    <div class="progress-bar-container">
      <div class="progress-bar" style="width: <%= @student.progress_percentage %>%;"></div>
    </div>
  </div>

  <% @textbooks.each do |textbook| %>
    <div class="textbook-section">
      <h3 class="textbook-title"><%= textbook.title %></h3>

      <!-- スマホ対応：tableをスクロールできるように -->
      <div class="table-wrapper">
        <table class="unit-table">
          <thead>
            <tr>
              <th>単元</th>
              <th>進捗</th>
              <th>期間</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% textbook.units.each do |unit| %>
              <tr>
                <td class="unit-title"><%= unit.title %></td>
                <td class="unit-progress">
                  <div class="unit-progress-bar">
                    <div class="fill" style="width: <%= unit.progress %>%;"></div>
                  </div>
                  <span class="progress-text"><%= unit.progress %>%</span>
                </td>
                <td class="unit-dates">
                  <%= unit.start_date %> ~ <%= unit.end_date %>
                </td>
                <td class="unit-actions">
                  <% if unit.progress < 100 %>
                    <button class="btn-complete">完了</button>
                  <% else %>
                    <span class="status-done">完了済み</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <hr>

  <div class="study-time-section">
  <h3>📊 学習時間の記録</h3>

  <%= form_with model: [@student, StudyTime.new], local: true do |f| %>
    <div class="form-group">
      <%= f.label :study_date, "日付" %>
      <%= f.date_field :study_date, value: Date.today %>
    </div>

    <div class="form-group">
      <%= f.label :minutes, "学習時間（分）" %>
      <%= f.number_field :minutes, min: 1, step: 5 %>
    </div>

    <%= f.submit "記録する", class: "btn-save" %>
  <% end %>
</div>

<hr>

<div class="study-time-chart">
  <h3>🗓 1週間の学習時間</h3>
  <canvas id="studyChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("turbo:load", () => {
    const ctx = document.getElementById("studyChart");
    if (!ctx) return;

    const labels = <%= @student.study_times.where(study_date: 7.days.ago.to_date..Date.today)
                              .order(:study_date)
                              .pluck(:study_date).map(&:strftime).to_json.html_safe %>;
    const data = <%= @student.study_times.where(study_date: 7.days.ago.to_date..Date.today)
                              .order(:study_date)
                              .pluck(:minutes).to_json.html_safe %>;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: '学習時間（分）',
          data: data,
          backgroundColor: '#6366f1'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, title: { display: true, text: '分' } }
        }
      }
    });
  });
</script>